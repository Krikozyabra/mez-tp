name: Deploy Django + Frontend to Production

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
    types: [closed]

jobs:
  deploy:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy to server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            set -e
            
            cd ~/mez-tp
            
            # –ë—ç–∫–∞–ø env —Ñ–∞–π–ª–æ–≤
            if [ -f .env ]; then
              cp .env .env.backup
            fi
            
            if [ -f backend/.env ]; then
              cp backend/.env backend/.env.backup
            fi

            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            git fetch origin
            git reset --hard origin/master

            # –û—á–∏—â–∞–µ–º, —Å–æ—Ö—Ä–∞–Ω—è—è env —Ñ–∞–π–ª—ã
            git clean -fd -e "*.env" -e "backend/.env" -e ".env.backup" -e "backend/.env.backup" -e "frontend/.env*" 2>/dev/null || true

            # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º env —Ñ–∞–π–ª—ã
            if [ -f .env.backup ]; then
              mv .env.backup .env
            fi
            
            if [ -f backend/.env.backup ]; then
              mv backend/.env.backup backend/.env
            fi

            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
            docker-compose down || true


            # –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –ø—Ä–æ—Å—Ç–æ —Å–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
            echo "–°–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã..."
            docker-compose up -d --build

            # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
            sleep 15

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
            docker-compose ps

            # –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ —Å–±–æ—Ä —Å—Ç–∞—Ç–∏–∫–∏
            echo "–í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
            docker-compose exec -T backend python manage.py migrate --noinput || echo "–ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–æ–ø—É—â–µ–Ω—ã"
            
            echo "–°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã..."
            docker-compose exec -T backend python manage.py collectstatic --noinput || echo "–°—Ç–∞—Ç–∏–∫–∞ –Ω–µ —Å–æ–±—Ä–∞–Ω–∞"

            # –û—á–∏—Å—Ç–∫–∞
            docker system prune -f

            echo "========================================"
            echo "üéâ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
            echo "üîó Frontend: http://${{ secrets.SSH_HOST }}"
            echo "üîó Backend API: http://${{ secrets.SSH_HOST }}:8000"
            echo "üîó Admin: http://${{ secrets.SSH_HOST }}:8000/admin"
            echo ""
            echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:"
            echo "  docker-compose logs frontend"
            echo "  docker-compose logs backend"
            echo "========================================"
          EOF